<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subtitle Annotation Tool</title>
    <link rel="stylesheet" href="src/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Subtitle Annotation Tool</h1>
            <p class="subtitle-text">Tag subtitle lines with character names for analysis and export</p>
            <p id="currentFile" class="subtitle-text" style="display: none; margin-top: 5px; font-weight: 600; color: #2c3e50;">üìÑ <span id="filename"></span></p>
        </header>

        <!-- File Upload Section -->
        <div class="upload-section" id="uploadSection">
            <div class="upload-zone" id="uploadZone">
                <h2>üìÅ Load Subtitle File</h2>
                <p>Drag and drop a .srt or .ass file here, or click to browse</p>
                <input type="file" id="fileInput" accept=".srt,.ass">
                <button class="btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
            </div>
        </div>

        <!-- Character Management Section -->
        <div class="character-management" id="characterManagement">
            <h2>Character Management</h2>
            <p id="characterInfo">Review and manage the character list</p>
            <p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">üí° Tip: Use <kbd style="padding: 2px 5px; background: #f5f5f5; border: 1px solid #ccc; border-radius: 3px;">Ctrl+Z</kbd> to undo and <kbd style="padding: 2px 5px; background: #f5f5f5; border: 1px solid #ccc; border-radius: 3px;">Ctrl+Y</kbd> to redo changes</p>

            <div style="margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn" id="mergeBtn" onclick="showMergeModal()" disabled>Merge Characters</button>
                <button class="btn" onclick="sortCharactersByFrequency()">Sort by Frequency</button>
                <button class="btn" onclick="exportCharacterList()">Export Character List</button>
                <button class="btn" onclick="document.getElementById('importCharacterFile').click()">Import Character List</button>
                <button class="btn btn-danger" onclick="clearGlobalCharacterList()">Clear Global List</button>
                <input type="file" id="importCharacterFile" accept=".json" style="display: none;" onchange="importCharacterList(event)">
            </div>

            <div id="characterList" class="character-list"></div>

            <div class="add-character">
                <input type="text" id="newCharacterInput" placeholder="Add new character...">
                <button class="btn" onclick="addNewCharacter()">Add</button>
            </div>

            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-success" onclick="startAnnotating()">Start Annotating</button>
                <button class="btn btn-secondary" onclick="resetApp()">Cancel</button>
            </div>
        </div>

        <!-- Annotation Workspace -->
        <div class="annotation-workspace" id="annotationWorkspace">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0 / 0 annotated</div>
            </div>

            <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; display: flex; align-items: center; gap: 10px;">
                <label for="characterFilter" style="font-weight: 600;">Filter:</label>
                <select id="characterFilter" onchange="handleFilterChange()" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; flex: 1; max-width: 300px;">
                    <option value="all">All lines</option>
                    <option value="unannotated">Unannotated only</option>
                </select>
                <span id="filterStats" style="color: #6c757d; font-size: 14px;"></span>
            </div>

            <div class="keyboard-hints">
                <h3>Keyboard Shortcuts</h3>
                <p style="margin-bottom: 10px; font-size: 14px;">The line with the <strong>orange border</strong> is the active target for keyboard shortcuts.</p>
                <div class="shortcuts" id="shortcutHints"></div>
            </div>

            <div style="margin: 15px 0; padding: 12px; background-color: #e8f4f8; border: 1px solid #3498db; border-radius: 4px; display: flex; align-items: center; justify-content: space-between;">
                <span style="font-size: 14px; color: #2c3e50;">
                    <strong>Scene Management:</strong> Click on a line to make it active, then insert a scene break below it. Press ESC to clear selection.
                </span>
                <button class="btn" onclick="insertSceneBreak()" style="background-color: #3498db; color: white;">
                    Insert Scene Break (Alt+N)
                </button>
            </div>

            <div class="subtitle-list" id="subtitleList"></div>

            <div class="export-section">
                <div>
                    <strong id="exportStats">Ready to export</strong>
                </div>
                <div>
                    <button class="btn" onclick="editCharacters()">Edit Characters</button>
                    <button class="btn btn-success" onclick="showExportModal()">Export</button>
                    <button class="btn btn-secondary" onclick="resetApp()">New File</button>
                    <button class="btn btn-danger" onclick="clearSession()">Clear Session</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <h3>Export Annotations</h3>

            <p><strong>Format:</strong></p>
            <div style="margin: 10px 0 20px 0;">
                <label>
                    <input type="radio" name="exportFormat" value="json" checked> JSON (for LLM consumption)
                </label>
                <br>
                <label>
                    <input type="radio" name="exportFormat" value="csv"> CSV (for spreadsheet analysis)
                </label>
                <br>
                <label>
                    <input type="radio" name="exportFormat" value="txt"> TXT (screenplay/dialogue format)
                </label>
            </div>

            <p><strong>Content:</strong></p>
            <div style="margin: 10px 0 20px 0;">
                <label>
                    <input type="radio" name="exportType" value="annotated" checked> Only annotated lines
                </label>
                <br>
                <label>
                    <input type="radio" name="exportType" value="all"> All lines (including unannotated)
                </label>
            </div>

            <div id="txtOptions" style="margin: 10px 0 20px 0; display: none;">
                <p><strong>TXT Options:</strong></p>
                <label>
                    <input type="checkbox" id="suppressRepeatedNames"> Suppress repeated character names
                </label>
                <p style="font-size: 12px; color: #7f8c8d; margin: 5px 0 0 20px;">‚ö†Ô∏è Note: May be ambiguous if the same character appears in consecutive scenes</p>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeExportModal()">Cancel</button>
                <button class="btn btn-success" onclick="handleExport()">Export</button>
            </div>
        </div>
    </div>

    <!-- Merge Characters Modal -->
    <div class="modal" id="mergeModal">
        <div class="modal-content">
            <h3>Merge Characters</h3>
            <p>Select the canonical name for the merged character:</p>

            <div id="mergeOptions" style="margin: 20px 0;">
                <!-- Radio buttons will be populated dynamically -->
            </div>

            <div style="margin: 20px 0;">
                <label>
                    <input type="radio" name="mergeCanonical" value="custom"> Custom name:
                </label>
                <input type="text" id="customCanonicalName" style="margin-left: 10px; padding: 8px; width: 250px;">
            </div>

            <p id="mergePreview" style="margin: 15px 0; padding: 10px; background-color: #f0f0f0; border-radius: 4px; font-size: 14px;"></p>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeMergeModal()">Cancel</button>
                <button class="btn btn-success" onclick="confirmMerge()">Merge</button>
            </div>
        </div>
    </div>

    <!-- Load JavaScript modules in dependency order -->
    <script src="src/state.js"></script>           <!-- 1. Global state -->
    <script src="src/parsers.js"></script>         <!-- 2. File parsers -->
    <script src="src/persistence.js"></script>     <!-- 3. localStorage -->
    <script src="src/undo.js"></script>            <!-- 4. Undo/redo -->
    <script src="src/characters.js"></script>      <!-- 5. Character mgmt -->
    <script src="src/scenes.js"></script>          <!-- 6. Scene mgmt -->
    <script src="src/annotation.js"></script>      <!-- 7. Annotation workspace -->
    <script src="src/export.js"></script>          <!-- 8. Export functions -->
    <script src="src/app.js"></script>             <!-- 9. Initialization -->
</body>
</html>
