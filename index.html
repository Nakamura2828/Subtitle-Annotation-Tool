<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subtitle Annotation Tool</title>
    <link rel="stylesheet" href="src/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Subtitle Annotation Tool</h1>
            <p class="subtitle-text">Tag subtitle lines with character names for analysis and export</p>
            <p id="currentFile" class="subtitle-text" style="display: none; margin-top: 5px; font-weight: 600; color: #2c3e50;">üìÑ <span id="filename"></span></p>
        </header>

        <!-- File Upload Section -->
        <div class="upload-section" id="uploadSection">
            <div class="upload-zone" id="uploadZone">
                <h2>üìÅ Load Subtitle Files</h2>
                <p style="margin-bottom: 20px;">Load primary file (required) and optional secondary file for dual-language annotation</p>

                <!-- Primary File -->
                <div style="margin-bottom: 15px; padding: 15px; background: rgba(52, 152, 219, 0.05); border-radius: 4px; border: 1px solid rgba(52, 152, 219, 0.2);">
                    <h3 style="margin: 0 0 8px 0; font-size: 16px; color: #2c3e50;">Primary File (Required)</h3>
                    <p style="margin: 0 0 10px 0; font-size: 13px; color: #7f8c8d;">This file will be annotated with character names</p>
                    <input type="file" id="fileInput" accept=".srt,.ass" style="display: none;">
                    <button class="btn" onclick="document.getElementById('fileInput').click()">Choose Primary File</button>
                    <span id="primaryFilename" style="margin-left: 10px; font-weight: 600; color: #27ae60;"></span>
                </div>

                <!-- Secondary File (Optional) -->
                <div style="padding: 15px; background: rgba(149, 165, 166, 0.05); border-radius: 4px; border: 1px solid rgba(149, 165, 166, 0.2);">
                    <h3 style="margin: 0 0 8px 0; font-size: 16px; color: #2c3e50;">Secondary File (Optional)</h3>
                    <p style="margin: 0 0 10px 0; font-size: 13px; color: #7f8c8d;">Reference language (e.g., Japanese) shown alongside primary for context</p>
                    <input type="file" id="secondaryFileInput" accept=".srt,.ass" style="display: none;">
                    <button class="btn btn-secondary" onclick="document.getElementById('secondaryFileInput').click()">Choose Secondary File</button>
                    <span id="secondaryFilename" style="margin-left: 10px; font-weight: 600; color: #27ae60;"></span>
                    <button class="btn btn-danger" id="clearSecondaryBtn" onclick="clearSecondaryFile()" style="margin-left: 10px; display: none;">Clear</button>
                </div>

                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-success" id="processBothFilesBtn" onclick="processBothFiles()" style="display: none;">Continue</button>
                </div>
            </div>

            <!-- Session Picker (populated by renderSessionPicker()) -->
            <div id="sessionPickerContainer" style="display: none; margin-top: 20px;"></div>

            <!-- Load Project File -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center;">
                <p style="font-size: 13px; color: #7f8c8d; margin-bottom: 10px;">Or load a previously saved project file</p>
                <input type="file" id="importProjectInput" accept=".saproj,.json" style="display: none;" onchange="importProject(event)">
                <button class="btn btn-secondary" onclick="document.getElementById('importProjectInput').click()">Load Project File</button>
            </div>
        </div>

        <!-- Character Management Section -->
        <div class="character-management" id="characterManagement">
            <h2>Character Management</h2>
            <p id="characterInfo">Review and manage the character list</p>
            <p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">üí° Tip: Use <kbd style="padding: 2px 5px; background: #f5f5f5; border: 1px solid #ccc; border-radius: 3px;">Ctrl+Z</kbd> to undo and <kbd style="padding: 2px 5px; background: #f5f5f5; border: 1px solid #ccc; border-radius: 3px;">Ctrl+Y</kbd> to redo changes</p>

            <div style="margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn" id="mergeBtn" onclick="showMergeModal()" disabled>Merge Characters</button>
                <button class="btn" onclick="sortCharactersByFrequency()">Sort by Frequency</button>
                <button class="btn" onclick="exportCharacterList()">Export Character List</button>
                <button class="btn" onclick="document.getElementById('importCharacterFile').click()">Import Character List</button>
                <button class="btn btn-danger" onclick="clearGlobalCharacterList()">Clear Global List</button>
                <input type="file" id="importCharacterFile" accept=".json" style="display: none;" onchange="importCharacterList(event)">
            </div>

            <div id="characterList" class="character-list"></div>

            <div class="add-character">
                <input type="text" id="newCharacterInput" placeholder="Add new character...">
                <button class="btn" onclick="addNewCharacter()">Add</button>
            </div>

            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-success" onclick="startAnnotating()">Start Annotating</button>
                <button class="btn btn-secondary" onclick="resetApp()">Cancel</button>
            </div>
        </div>

        <!-- Annotation Workspace -->
        <div class="annotation-workspace" id="annotationWorkspace">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0 / 0 annotated</div>
            </div>

            <div style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                <!-- Scene Filter -->
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <label for="sceneFilter" style="font-weight: 600; min-width: 100px;">Scene Filter:</label>
                    <select id="sceneFilter" onchange="handleSceneFilterChange()" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; flex: 1; max-width: 300px;">
                        <option value="all">All scenes</option>
                    </select>
                    <span id="sceneFilterStats" style="color: #6c757d; font-size: 14px;"></span>
                </div>
                <!-- Line Filter -->
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="characterFilter" style="font-weight: 600; min-width: 100px;">Line Filter:</label>
                    <select id="characterFilter" onchange="handleFilterChange()" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; flex: 1; max-width: 300px;">
                        <option value="all">All lines</option>
                        <option value="unannotated">Unannotated only</option>
                    </select>
                    <span id="filterStats" style="color: #6c757d; font-size: 14px;"></span>
                </div>
            </div>

            <div class="keyboard-hints">
                <h3>Keyboard Shortcuts</h3>
                <p style="margin-bottom: 10px; font-size: 14px;">The line with the <strong>orange border</strong> is the active target for keyboard shortcuts.</p>
                <div class="shortcuts" id="shortcutHints"></div>
            </div>

            <!-- Annotation Transfer (v1.7.1) - only visible when secondary track loaded -->
            <div id="annotationTransferBar" style="display: none; margin: 15px 0; padding: 12px; background-color: #fef3e2; border: 1px solid #f0ad4e; border-radius: 4px; align-items: center; justify-content: space-between;">
                <span style="font-size: 14px; color: #2c3e50;">
                    <strong>Annotation Transfer:</strong> Replace primary text with secondary text, keeping all character annotations intact.
                </span>
                <button class="btn" onclick="showTransferModal()" style="background-color: #f0ad4e; color: white;">
                    Apply Secondary as Primary
                </button>
            </div>

            <div style="margin: 15px 0; padding: 12px; background-color: #e8f4f8; border: 1px solid #3498db; border-radius: 4px; display: flex; align-items: center; justify-content: space-between;">
                <span style="font-size: 14px; color: #2c3e50;">
                    <strong>Scene Management:</strong> Click on a line to make it active, then insert a scene break below it. Press ESC to clear selection.
                </span>
                <button class="btn" onclick="insertSceneBreak()" style="background-color: #3498db; color: white;">
                    Insert Scene Break (Alt+N)
                </button>
            </div>

            <div class="subtitle-list" id="subtitleList"></div>

            <div class="export-section">
                <div>
                    <strong id="exportStats">Ready to export</strong>
                </div>
                <div>
                    <button class="btn" onclick="editCharacters()">Edit Characters</button>
                    <button class="btn btn-success" onclick="showExportModal()">Export</button>
                    <button class="btn" onclick="exportProject()">Save Project</button>
                    <button class="btn btn-secondary" onclick="resetApp()">New File</button>
                    <button class="btn btn-danger" onclick="clearSession()">Clear Session</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <h3>Export Annotations</h3>

            <p><strong>Format:</strong></p>
            <div style="margin: 10px 0 20px 0;">
                <label>
                    <input type="radio" name="exportFormat" value="json" checked> JSON (for LLM consumption)
                </label>
                <br>
                <label>
                    <input type="radio" name="exportFormat" value="csv"> CSV (for spreadsheet analysis)
                </label>
                <br>
                <label>
                    <input type="radio" name="exportFormat" value="txt"> TXT (screenplay/dialogue format)
                </label>
            </div>

            <p><strong>Content:</strong></p>
            <div style="margin: 10px 0 20px 0;">
                <label>
                    <input type="radio" name="exportType" value="annotated" checked> Only annotated lines
                </label>
                <br>
                <label>
                    <input type="radio" name="exportType" value="all"> All lines (including unannotated)
                </label>
            </div>

            <div id="trackOptions" style="margin: 10px 0 20px 0; display: none;">
                <p><strong>Track:</strong></p>
                <label>
                    <input type="radio" name="exportTrack" value="both" checked> Both (primary + secondary)
                </label>
                <br>
                <label>
                    <input type="radio" name="exportTrack" value="primary"> Primary text only
                </label>
                <br>
                <label>
                    <input type="radio" name="exportTrack" value="secondary"> Secondary text only
                </label>
            </div>

            <div id="txtOptions" style="margin: 10px 0 20px 0; display: none;">
                <p><strong>TXT Options:</strong></p>
                <label>
                    <input type="checkbox" id="suppressRepeatedNames" checked> Suppress repeated character names
                </label>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeExportModal()">Cancel</button>
                <button class="btn btn-success" onclick="handleExport()">Export</button>
            </div>
        </div>
    </div>

    <!-- Merge Characters Modal -->
    <div class="modal" id="mergeModal">
        <div class="modal-content">
            <h3>Merge Characters</h3>
            <p>Select the canonical name for the merged character:</p>

            <div id="mergeOptions" style="margin: 20px 0;">
                <!-- Radio buttons will be populated dynamically -->
            </div>

            <div style="margin: 20px 0;">
                <label>
                    <input type="radio" name="mergeCanonical" value="custom"> Custom name:
                </label>
                <input type="text" id="customCanonicalName" style="margin-left: 10px; padding: 8px; width: 250px;">
            </div>

            <p id="mergePreview" style="margin: 15px 0; padding: 10px; background-color: #f0f0f0; border-radius: 4px; font-size: 14px;"></p>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeMergeModal()">Cancel</button>
                <button class="btn btn-success" onclick="confirmMerge()">Merge</button>
            </div>
        </div>
    </div>

    <!-- Link Secondary Modal (v1.6.1) -->
    <div class="modal" id="linkSecondaryModal">
        <div class="modal-content" style="max-width: 700px;">
            <h3>Link Secondary Line</h3>
            <p id="linkSecondaryInfo" style="margin-bottom: 15px; color: #6c757d;"></p>

            <div style="margin-bottom: 15px; padding: 10px; background: rgba(52, 152, 219, 0.05); border: 1px solid rgba(52, 152, 219, 0.2); border-radius: 4px;">
                <strong>Primary line:</strong>
                <div id="linkPrimaryText" style="margin-top: 5px;"></div>
            </div>

            <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                <strong>Select secondary line(s):</strong>
                <button class="btn btn-secondary" onclick="clearLinkSelection()" style="padding: 4px 12px; font-size: 13px;">Clear Selection</button>
            </div>

            <div id="secondaryLineList" class="secondary-line-list">
                <!-- Populated dynamically -->
            </div>

            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                <strong>Shift All Below This Point:</strong>
                <p style="font-size: 13px; color: #6c757d; margin: 5px 0;">Re-align all lines from here onward by shifting secondary associations</p>
                <div style="display: flex; gap: 10px; margin-top: 8px;">
                    <button class="btn" onclick="shiftSecondaryBelow(-1)" style="padding: 6px 16px; font-size: 14px;">Shift Up (-1)</button>
                    <button class="btn" onclick="shiftSecondaryBelow(1)" style="padding: 6px 16px; font-size: 14px;">Shift Down (+1)</button>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeLinkSecondaryModal()">Cancel</button>
                <button class="btn btn-success" onclick="confirmLinkSecondary()">Apply</button>
            </div>
        </div>
    </div>

    <!-- Annotation Transfer Modal (v1.7.1) -->
    <div class="modal" id="transferModal">
        <div class="modal-content">
            <h3>Apply Secondary as Primary</h3>
            <p>This will replace primary text with secondary text for all aligned lines. Character annotations will be preserved.</p>

            <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 4px;">
                <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="transferKeepOriginal" checked style="margin-top: 3px;">
                    <div>
                        <strong>Keep original text for unaligned lines</strong>
                        <div style="font-size: 13px; color: #6c757d; margin-top: 2px;">If unchecked, unaligned lines will have their text blanked</div>
                    </div>
                </label>
            </div>

            <div id="transferPreview" style="margin: 15px 0; padding: 10px; background-color: #f0f0f0; border-radius: 4px; font-size: 14px;"></div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeTransferModal()">Cancel</button>
                <button class="btn btn-success" onclick="confirmTransfer()">Apply Transfer</button>
            </div>
        </div>
    </div>

    <!-- Dual-Language Track Selection Modal (for secondary file) -->
    <div class="modal" id="dualLanguageModal">
        <div class="modal-content">
            <h3>Dual-Language File Detected</h3>
            <p>The secondary file contains two language tracks. Which track would you like to load as the secondary reference?</p>

            <div id="dualLanguageOptions" style="margin: 20px 0;">
                <!-- Radio buttons populated dynamically -->
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeDualLanguageModal()">Cancel</button>
                <button class="btn btn-success" onclick="confirmDualLanguageChoice()">Load Selected Track</button>
            </div>
        </div>
    </div>

    <!-- Load JavaScript modules in dependency order -->
    <script src="src/state.js"></script>           <!-- 1. Global state -->
    <script src="src/parsers.js"></script>         <!-- 2. File parsers -->
    <script src="src/persistence.js"></script>     <!-- 3. localStorage -->
    <script src="src/undo.js"></script>            <!-- 4. Undo/redo -->
    <script src="src/characters.js"></script>      <!-- 5. Character mgmt -->
    <script src="src/scenes.js"></script>          <!-- 6. Scene mgmt -->
    <script src="src/annotation.js"></script>      <!-- 7. Annotation workspace -->
    <script src="src/export.js"></script>          <!-- 8. Export functions -->
    <script src="src/app.js"></script>             <!-- 9. Initialization -->
</body>
</html>
